
╔══════════════════════════════════════════════════════════════════════════╗
║                    TANG NANO 4K - SOBEL SYSTEM ARCHITECTURE              ║
║                         Author: Nguyễn Văn Đạt - 2025                    ║
╚══════════════════════════════════════════════════════════════════════════╝

                                 ┌─────────────┐
                                 │  sys_clk    │
                                 │  sys_resetn │
                                 └──────┬──────┘
                                        │
                    ┌───────────────────┼───────────────────┐
                    │                   │                   │
            ┌───────▼────────┐  ┌──────▼───────┐  ┌────────▼────────┐
            │   VIDEO_TOP    │  │  UART_TOP    │  │   System Ctrl   │
            │                │  │              │  │                 │
            │  ┌──────────┐  │  │  ┌────────┐ │  │                 │
            │  │ Camera   │  │  │  │ TX/RX  │ │  │  Button/LED     │
            │  │ OV2640   │  │  │  │        │ │  │  Control        │
            │  └─────┬────┘  │  │  └───┬────┘ │  │                 │
            │        │       │  │      │      │  │                 │
            │  ┌─────▼─────┐ │  │  ┌───▼────┐ │  │                 │
            │  │RGB→Gray   │ │  │  │Serial  │ │  │                 │
            │  │Converter  │ │  │  │Port    │ │  │                 │
            │  └─────┬─────┘ │  │  └────────┘ │  │                 │
            │        │       │  └──────────────┘  └─────────────────┘
            │  ┌─────▼──────────┐                         │
            │  │ Line Buffer    │◄────────────────────────┘
            │  │ (3-line BRAM)  │      Control Signals
            │  └─────┬──────────┘
            │        │
            │  ┌─────▼──────────┐
            │  │ Gaussian Blur  │
            │  │   3x3 Kernel   │
            │  └─────┬──────────┘
            │        │
            │  ┌─────▼──────────┐
            │  │ Sobel Kernel   │
            │  │   Gx, Gy       │
            │  └─────┬──────────┘
            │        │
            │  ┌─────▼──────────┐
            │  │ Edge Magnitude │
            │  │  sqrt(Gx²+Gy²) │
            │  └─────┬──────────┘
            │        │
            │  ┌─────▼──────────┐
            │  │ Frame Buffer   │
            │  │  (HyperRAM)    │
            │  └─────┬──────────┘
            │        │
            │  ┌─────▼──────────┐
            │  │  DVI/HDMI TX   │
            │  │                │
            └──┴────────────────┴──►  TMDS Output
                                     (tmds_clk_p/n)
                                     (tmds_data_p/n[2:0])

═══════════════════════════════════════════════════════════════════════════
                            SIGNAL FLOW SUMMARY
═══════════════════════════════════════════════════════════════════════════
1. Camera → RGB565 pixel stream (PIXCLK, HREF, VSYNC, PIXDATA[7:0])
2. RGB565 → Grayscale (8-bit intensity)
3. Line Buffer → 3x3 window extraction
4. Gaussian Blur → noise reduction
5. Sobel Kernel → gradient calculation (Gx, Gy)
6. Edge Magnitude → |gradient| = sqrt(Gx² + Gy²)
7. Frame Buffer → HyperRAM storage
8. HDMI TX → TMDS serialized output

UART: Parallel debug/control interface
  - Commands: Enable/disable Sobel, read statistics
  - Baud: 115200, 8N1
═══════════════════════════════════════════════════════════════════════════



╔══════════════════════════════════════════════════════════════════════════╗
║                    DETAILED PORT CONNECTIONS                              ║
╚══════════════════════════════════════════════════════════════════════════╝


┌─────────────────────────────────────────────────────────────────────────┐
│ SOBEL EDGE DETECTION PIPELINE                                           │
└─────────────────────────────────────────────────────────────────────────┘

1. RGB to Grayscale Converter (rgb_to_gray.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk (27 MHz)            │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ rgb565         │ [15:0]       │ camera pixel data           │
   │ gray           │ [7:0]        │ → line_buffer.pixel_in      │
   └────────────────┴──────────────┴─────────────────────────────┘

2. Line Buffer (line_buffer.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk                     │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ pixel_in       │ [7:0]        │ rgb_to_gray.gray            │
   │ href           │ 1            │ camera HREF                 │
   │ vsync          │ 1            │ camera VSYNC                │
   │ p11-p33        │ [7:0] x 9    │ → gaussian_blur.window      │
   │ valid          │ 1            │ → gaussian_blur.valid_in    │
   └────────────────┴──────────────┴─────────────────────────────┘

3. Gaussian Blur (gaussian_blur.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk                     │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ p11-p33        │ [7:0] x 9    │ line_buffer outputs         │
   │ valid_in       │ 1            │ line_buffer.valid           │
   │ blurred_p11-33 │ [7:0] x 9    │ → sobel_kernel.window       │
   │ valid_out      │ 1            │ → sobel_kernel.valid_in     │
   └────────────────┴──────────────┴─────────────────────────────┘

4. Sobel Kernel (sobel_kernel.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk                     │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ p11-p33        │ [7:0] x 9    │ gaussian_blur outputs       │
   │ valid_in       │ 1            │ gaussian_blur.valid_out     │
   │ gx             │ [10:0]       │ → edge_mag.gx               │
   │ gy             │ [10:0]       │ → edge_mag.gy               │
   │ valid_out      │ 1            │ → edge_mag.valid_in         │
   └────────────────┴──────────────┴─────────────────────────────┘

5. Edge Magnitude (edge_mag.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk                     │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ gx             │ [10:0]       │ sobel_kernel.gx             │
   │ gy             │ [10:0]       │ sobel_kernel.gy             │
   │ valid_in       │ 1            │ sobel_kernel.valid_out      │
   │ magnitude      │ [7:0]        │ → display logic             │
   │ valid_out      │ 1            │ → pixel_valid               │
   └────────────────┴──────────────┴─────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│ UART INTERFACE                                                           │
└─────────────────────────────────────────────────────────────────────────┘

1. UART TX (uart_tx.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk (27 MHz)            │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ tx_data        │ [7:0]        │ control logic               │
   │ tx_valid       │ 1            │ control logic               │
   │ tx_ready       │ 1            │ → control logic             │
   │ tx_pin         │ 1            │ → Physical UART TX pin      │
   └────────────────┴──────────────┴─────────────────────────────┘

2. UART RX (uart_rx.v)
   ┌────────────────┬──────────────┬─────────────────────────────┐
   │ Port           │ Width        │ Connection                  │
   ├────────────────┼──────────────┼─────────────────────────────┤
   │ clk            │ 1            │ sys_clk                     │
   │ rst_n          │ 1            │ sys_resetn                  │
   │ rx_pin         │ 1            │ Physical UART RX pin        │
   │ rx_data        │ [7:0]        │ → command decoder           │
   │ rx_valid       │ 1            │ → command decoder           │
   └────────────────┴──────────────┴─────────────────────────────┘

